<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hobby.challenge.fobackend.mapper.ChallengeMapper">

	<!-- ì±Œë¦°ì§€ ìƒì„± -->
	<insert id="insertChallenge"
			parameterType="com.hobby.challenge.fobackend.entity.Challenge"
			useGeneratedKeys="true"
			keyProperty="challengeId">
		INSERT INTO CHALLENGE (TITLE
							, DESCRIPTION
							, START_DATE
							, END_DATE
							, CATEGORY_ID
							, CREATED_BY)
		VALUES (#{title}
			 , #{description}
			 , #{startDate}
			 , #{endDate}
			 , #{categoryId}
			 , #{createdBy})
	</insert>

	<!-- Challenge User ì¡°ì¸ìš© resultMap-->
 	<resultMap id="ChallengeWithCreator" type="com.hobby.challenge.fobackend.entity.Challenge">
	    <id column="challengeId" property="challengeId"/>
	    <result column="title" property="title"/>
	    <result column="description" property="description"/>
	    <result column="startDate" property="startDate"/>
	    <result column="endDate" property="endDate"/>
	    <result column="categoryId" property="categoryId"/>
	    <result column="createdBy" property="createdBy"/>
	    <result column="createdDate" property="createdDate"/>
	    <result column="modifiedDate" property="modifiedDate"/>
	    <result column="isFavorite" property="isFavorite"/>
	    
	    <!-- CREATED_BYë¡œ USER í…Œì´ë¸”(USER_ID)ì™€ ì¡°ì¸ -->
		<association property="creator" javaType="com.hobby.challenge.fobackend.entity.User">
			<id column="userId" property="userId"/>
      		<result column="nickname" property="nickname"/>
    	</association>
 	</resultMap>
 	
 	<!-- íŽ˜ì´ì§• -->
 	<!-- ë™ì  ì¿¼ë¦¬ xmlíƒœê·¸ ì¶”ê°€í•´ ì œëª© ê²€ìƒ‰ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰  -->
 	<select id="findAllWithPaging" resultMap="ChallengeWithCreator">
	    SELECT C.CHALLENGE_ID AS challengeId
      		 , C.TITLE AS title
      		 , C.DESCRIPTION AS description
      		 , C.CATEGORY_ID AS categoryId
      		 , C.CREATED_BY AS createdBy
      		 , C.START_DATE AS startDate
      		 , C.END_DATE AS endDate
      		 , C.CREATED_DATE createdDate
      		 , C.MODIFIED_DATE modifiedDate
	         , CASE WHEN FC.USER_ID IS NOT NULL THEN TRUE ELSE FALSE END AS isFavorite <!-- ê°€ìƒ ì»¬ëŸ¼ ìƒì„± ê´€ì‹¬ ì±Œë¦°ì§€ ì—¬ë¶€-->
	         , U.USER_ID AS userId
  			 , U.NICKNAME AS nickname
	      FROM CHALLENGE C
	 LEFT JOIN FAVORITE_CHALLENGE FC 
	 	    ON C.CHALLENGE_ID = FC.CHALLENGE_ID 
	 	   AND FC.USER_ID = #{userId}
    INNER JOIN USER U
  			ON C.CREATED_BY = U.USER_ID
	   <where>
	   		 (C.IS_DELETED = 0 OR C.IS_DELETED IS NULL) <!-- ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸ ë˜ì§€ ì•Šì€ ì±Œë¦°ì§€ë§Œ ì¡°íšŒ -->
			<if test="search != null and search.trim() != ''">
				AND C.TITLE LIKE CONCAT('%', #{search}, '%')
		   </if>
			<if test="categoryId != null">
				AND C.CATEGORY_ID = #{categoryId}
		   </if>
	   </where>
	  ORDER BY C.CREATED_DATE DESC
	     LIMIT #{size} OFFSET #{offset}
	</select>
	
	<!-- ì „ì²´ ì±Œë¦°ì§€ ê°œìˆ˜ íŽ˜ì´ì§€ ìˆ˜ ê³„ì‚°ì„ ìœ„í•´ -->
	<select id="countAll" resultType="int">
	    SELECT COUNT(*) 
	      FROM CHALLENGE C
	    <where>
	       (C.IS_DELETED = 0 OR C.IS_DELETED IS NULL) <!-- ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸ ë˜ì§€ ì•Šì€ ì±Œë¦°ì§€ë§Œ ì¡°íšŒ -->
	      <if test="search != null and search.trim() != ''">
	        AND C.TITLE LIKE CONCAT('%', #{search}, '%')
	      </if>
	      <if test="categoryId != null">
	        AND C.CATEGORY_ID = #{categoryId}
	      </if>
	    </where>
	</select>

	<!-- ì „ì²´ ì±Œë¦°ì§€ ëª©ë¡ ì¡°íšŒ -->
	<select id="findAll" resultMap="ChallengeWithCreator">
		SELECT C.CHALLENGE_ID AS challengeId
			 , C.TITLE AS title
			 , C.DESCRIPTION AS description
			 , C.CATEGORY_ID AS categoryId
			 , C.CREATED_BY AS createdBy
			 , C.START_DATE AS startDate
			 , C.END_DATE AS endDate
			 , C.CREATED_DATE AS createdDate
			 , C.MODIFIED_DATE AS modifiedDate
			 , U.USER_ID AS userId
			 , U.NICKNAME AS nickname <!-- ìƒì„±ìž ë‹‰ë„¤ìž„ -->
		  FROM CHALLENGE C
	INNER JOIN USER U 
			ON C.CREATED_BY = U.USER_ID
	   	 WHERE (C.IS_DELETED = 0 OR C.IS_DELETED IS NULL) <!-- ì†Œí”„íŠ¸ ë”œë¦¬íŠ¸ ë˜ì§€ ì•Šì€ ì±Œë¦°ì§€ë§Œ ì¡°íšŒ -->
	  ORDER BY C.CREATED_DATE DESC
	</select>
	
    <!-- ë‹¨ê±´ ì¡°íšŒ ë‚´ê°€ ì°¸ì—¬í•œ ì±Œë¦°ì§€-->
    <select id="selectById"
        	resultMap="ChallengeWithCreator">
	    SELECT C.CHALLENGE_ID AS challengeId
	         , C.TITLE AS title
	         , C.DESCRIPTION AS description
	         , C.START_DATE AS startDate
	         , C.END_DATE AS endDate
	         , C.CATEGORY_ID AS categoryId
	         , C.CREATED_BY AS createdBy
	         , C.CREATED_DATE AS createdDate
	         , C.MODIFIED_DATE AS modifiedDate
	         , C.IS_DELETED AS isDeleted
	         , CASE WHEN FC.USER_ID IS NOT NULL THEN TRUE ELSE FALSE END AS isFavorite
	         , U.USER_ID AS userId
	         , U.NICKNAME AS nickname
	      FROM CHALLENGE C
     LEFT JOIN FAVORITE_CHALLENGE FC 
	        ON C.CHALLENGE_ID = FC.CHALLENGE_ID AND FC.USER_ID = #{userId}
    INNER JOIN USER U 
	        ON C.CREATED_BY = U.USER_ID
	     WHERE C.CHALLENGE_ID = #{challengeId}
	</select>
	


	
	 <!-- ìƒì„¸ í™”ë©´ìš© DTO ë§¤í•‘ -->
	<resultMap id="DetailMap" type="com.hobby.challenge.fobackend.dto.ChallengeDetailDTO">
	    <id column="challengeId" property="challengeId"/>
	    <result column="title" property="title"/>
	    <result column="description" property="description"/>
	    <result column="startDate" property="startDate"/>
	    <result column="endDate" property="endDate"/>
	    <result column="categoryId" property="categoryId"/>
	    <result column="isFavorite" property="isFavorite"/>
	    <result column="joined" property="joined"/>
	    <result column="creatorNickname" property="creatorNickname"/>
	 </resultMap>
	 
	   <!-- ìƒì„¸ ì¡°íšŒ ì¿¼ë¦¬ -->
	 <select id="selectDetailById" 
	 		 resultMap="DetailMap">
	    SELECT C.CHALLENGE_ID AS challengeId
	         , C.TITLE AS title
	         , C.DESCRIPTION AS description
	         , C.START_DATE AS startDate
	         , C.END_DATE AS endDate
	         , C.CATEGORY_ID AS categoryId
	         , C.CREATED_BY AS createdBy
	         , CASE WHEN FC.USER_ID IS NOT NULL THEN TRUE ELSE FALSE END AS isFavorite
	         , CASE WHEN EXISTS (
	                SELECT 1 
	                  FROM PARTICIPATION P
	                 WHERE P.CHALLENGE_ID = C.CHALLENGE_ID
	                   AND P.USER_ID = #{userId}
	                   AND P.STATUS = 'APPROVED'
	                ) THEN TRUE ELSE FALSE END AS joined
	         , U.NICKNAME AS creatorNickname
	      FROM CHALLENGE C
	 LEFT JOIN FAVORITE_CHALLENGE FC
	        ON C.CHALLENGE_ID = FC.CHALLENGE_ID
	       AND FC.USER_ID = #{userId}
	INNER JOIN USER U
	        ON C.CREATED_BY = U.USER_ID
	     WHERE C.CHALLENGE_ID = #{challengeId}
	</select>
	
	<!-- ì‚¬ìš©ìžì˜ í™œì„± ì±Œë¦°ì§€ ê°œìˆ˜ ì¡°íšŒ ì±Œë¦°ì§€ ìƒì„± í•˜ë‚˜ë§Œ í•˜ê²Œ í•˜ê¸° ìœ„í•¨-->
	<select id="countByCreator"
			parameterType="int"
			resultType="int">
			
		SELECT COUNT(*)
		  FROM CHALLENGE
		 WHERE CREATED_BY = #{userId}
		   AND (IS_DELETED = 0 OR IS_DELETED IS NULL)
		
	</select>
	
	<!-- ðŸ”¥ ì°¸ì—¬í•œ ì±Œë¦°ì§€ ì¡°íšŒìš© ResultMap (ìƒíƒœ í¬í•¨) -->
	<resultMap id="ChallengeWithStatus" type="com.hobby.challenge.fobackend.entity.Challenge" extends="ChallengeWithCreator">
	    <result column="challengeStatus" property="challengeStatus"/>
	</resultMap>

	<!-- ì°¸ì—¬í•œ ì±Œë¦°ì§€ ëª©ë¡ ì¡°íšŒ (ë§Œë£Œëœ ê²ƒë„ í¬í•¨) -->
	<select id="findByParticipation" resultMap="ChallengeWithStatus">
	    SELECT C.CHALLENGE_ID AS challengeId
	         , C.TITLE AS title
	         , C.DESCRIPTION AS description
	         , C.CATEGORY_ID AS categoryId
	         , C.CREATED_BY AS createdBy
	         , C.START_DATE AS startDate
	         , C.END_DATE AS endDate
	         , C.CREATED_DATE createdDate
	         , C.MODIFIED_DATE modifiedDate
	         , C.IS_DELETED AS isDeleted
	         , CASE WHEN FC.USER_ID IS NOT NULL THEN TRUE ELSE FALSE END AS isFavorite
	         , U.USER_ID AS userId
	         , U.NICKNAME AS nickname
	         , CASE 
	               WHEN C.IS_DELETED = 1 THEN 'EXPIRED'
	               WHEN C.END_DATE &lt; CURDATE() THEN 'EXPIRED' 
	               WHEN C.START_DATE > CURDATE() THEN 'UPCOMING'
	               ELSE 'ACTIVE'
	           END AS challengeStatus
	      FROM CHALLENGE C
	 LEFT JOIN FAVORITE_CHALLENGE FC 
	        ON C.CHALLENGE_ID = FC.CHALLENGE_ID 
	       AND FC.USER_ID = #{userId}
	INNER JOIN USER U
	        ON C.CREATED_BY = U.USER_ID
	     WHERE C.CHALLENGE_ID IN 
	           <foreach collection="challengeIds" item="id" open="(" close=")" separator=",">
	               #{id}
	           </foreach>
	  ORDER BY C.CREATED_DATE DESC
	</select>
	
	<!-- ì±Œë¦°ì§€ ìˆ˜ì • ì±Œë¦°ì§€ ìƒì„±ìžë§Œ ê°€ëŠ¥ -->
	<update id="updateChallenge"
        	parameterType="com.hobby.challenge.fobackend.entity.Challenge">
	    UPDATE CHALLENGE
	       SET TITLE = #{title},
	           DESCRIPTION = #{description},
	           START_DATE = #{startDate},
	           END_DATE = #{endDate},
	           CATEGORY_ID = #{categoryId},
	           MODIFIED_DATE = CURRENT_TIMESTAMP
	     WHERE CHALLENGE_ID = #{challengeId}
	</update>
	
    <!-- ë§Œë£Œëœ ì±Œë¦°ì§€ ì†Œí”„íŠ¸ ì‚­ì œ -->
    <update id="softDeleteExpiredChallenges" parameterType="date">
        UPDATE CHALLENGE
           SET IS_DELETED = 1
             , MODIFIED_DATE = NOW()
         WHERE #{today} > END_DATE  
           AND (IS_DELETED = 0 OR IS_DELETED IS NULL)
    </update>
    
     <!-- ì±Œë¦°ì§€ í•˜ë“œ ì‚­ì œ (ë¬¼ë¦¬ì  ì‚­ì œ) -->
    <delete id="hardDeleteChallenge" parameterType="int">
        DELETE FROM CHALLENGE 
        WHERE CHALLENGE_ID = #{challengeId}
          AND (IS_DELETED = 0 OR IS_DELETED IS NULL)
    </delete>
</mapper>